<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Scanner Platform</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon.png.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon.png.png">
    <link rel="shortcut icon" href="/static/images/favicon.png.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .sidebar {
            background-color: #2c3e50;
            color: white;
            min-height: 100vh;
            padding-top: 2rem;
        }
        
        .sidebar-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar-link i {
            margin-right: 0.75rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        .settings-card {
            margin-bottom: 1.5rem;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .settings-card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .subscription-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .subscription-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-expired {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .form-section {
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .feature-list {
            padding-left: 0;
            list-style: none;
        }
        
        .feature-list li {
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #198754;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 p-0 sidebar">
                <div class="text-center mb-4">
                    <h4>Scanner Platform</h4>
                    <p class="mb-0 small">Client Portal</p>
                </div>
                
                <div class="px-3">
                    <a href="/client/dashboard" class="sidebar-link">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="/client/scanners" class="sidebar-link">
                        <i class="bi bi-shield-check"></i> My Scanners
                    </a>
                    <a href="/client/reports" class="sidebar-link">
                        <i class="bi bi-file-earmark-text"></i> Scan Reports
                    </a>
                    <a href="/client/settings" class="sidebar-link active">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                    
                    <hr class="my-4">
                    
                    <a href="{{ url_for('auth.logout') }}" class="sidebar-link text-danger">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-auto main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2>Settings</h2>
                        <p class="text-muted">Manage your account and preferences</p>
                    </div>
                </div>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Settings Navigation -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                            <i class="bi bi-person me-2"></i>Profile
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="subscription-tab" data-bs-toggle="tab" data-bs-target="#subscription" type="button" role="tab">
                            <i class="bi bi-credit-card me-2"></i>Subscription
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                            <i class="bi bi-bell me-2"></i>Notifications
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                            <i class="bi bi-shield-lock me-2"></i>Security
                        </button>
                    </li>
                </ul>
                
                <!-- Settings Tab Content -->
                <div class="tab-content" id="settingsTabContent">
                    <!-- Profile Tab -->
                    <div class="tab-pane fade show active" id="profile" role="tabpanel">
                        <div class="card settings-card">
                            <div class="card-header settings-card-header">
                                <h4 class="mb-0">Profile Information</h4>
                            </div>
                            <div class="card-body">
                                <form method="post" action="{{ url_for('client.settings') }}" id="profileForm">
                                    <input type="hidden" name="action" value="update_profile">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="business_name" class="form-label">Business Name</label>
                                            <input type="text" class="form-control" id="business_name" name="business_name" 
                                                   value="{{ client.business_name|default('') }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="business_domain" class="form-label">Business Domain</label>
                                            <input type="text" class="form-control" id="business_domain" name="business_domain" 
                                                   value="{{ client.business_domain|default('') }}" placeholder="example.com" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="contact_email" class="form-label">Contact Email</label>
                                            <input type="email" class="form-control" id="contact_email" name="contact_email" 
                                                   value="{{ client.contact_email|default('') }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="contact_phone" class="form-label">Contact Phone</label>
                                            <input type="tel" class="form-control" id="contact_phone" name="contact_phone" 
                                                   value="{{ client.contact_phone|default('') }}">
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                            <i class="bi bi-save me-2"></i>Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subscription Tab -->
                    <div class="tab-pane fade" id="subscription" role="tabpanel">
                        <div class="card settings-card subscription-card">
                            <div class="card-header settings-card-header">
                                <h4 class="mb-0">Subscription Details</h4>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center mb-4">
                                    <div class="col-md-8">
                                        <h5>Current Plan: <span class="text-primary">{{ client.subscription_level|default('Basic')|title }}</span></h5>
                                        <p class="text-muted mb-0">
                                            Status: <span class="subscription-status {% if client.subscription_status == 'active' %}status-active{% else %}status-expired{% endif %}">
                                                {{ client.subscription_status|default('Active')|title }}
                                            </span>
                                        </p>
                                        {% if client.subscription_end %}
                                            <p class="text-muted small">Expires on: {{ client.subscription_end }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        {% if client.subscription_status == 'active' %}
                                            <a href="/client/billing/manage" class="btn btn-outline-primary">
                                                <i class="bi bi-gear me-2"></i>Manage Subscription
                                            </a>
                                        {% else %}
                                            <a href="/client/billing/upgrade" class="btn btn-primary">
                                                <i class="bi bi-arrow-up-circle me-2"></i>Upgrade Now
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card h-100">
                                            <div class="card-header text-center">
                                                <h5>Basic</h5>
                                                <h4 class="text-primary">$0<span class="text-muted">/month</span></h4>
                                            </div>
                                            <div class="card-body">
                                                <ul class="feature-list">
                                                    <li>1 scanner</li>
                                                    <li>10 scans per month</li>
                                                    <li>Basic branding</li>
                                                    <li>Email reports</li>
                                                    <li>Community support</li>
                                                </ul>
                                                <div class="text-center mt-3">
                                                    {% if client.subscription_level == 'basic' or not client.subscription_level %}
                                                        <button class="btn btn-outline-success" disabled>Current Plan</button>
                                                    {% else %}
                                                        <a href="/client/billing/downgrade?plan=basic" class="btn btn-outline-secondary">Downgrade</a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card h-100">
                                            <div class="card-header text-center">
                                                <h5>Starter</h5>
                                                <h4 class="text-primary">$59<span class="text-muted">/month</span></h4>
                                            </div>
                                            <div class="card-body">
                                                <ul class="feature-list">
                                                    <li>1 scanner</li>
                                                    <li>50 scans per month</li>
                                                    <li>White-label branding</li>
                                                    <li>Basic reporting</li>
                                                    <li>Email support</li>
                                                    <li>Client portal access</li>
                                                    <li>Basic integrations</li>
                                                </ul>
                                                <div class="text-center mt-3">
                                                    {% if client.subscription_level == 'starter' %}
                                                        <button class="btn btn-outline-success" disabled>Current Plan</button>
                                                    {% else %}
                                                        <a href="/client/billing/upgrade?plan=starter" class="btn btn-outline-primary">Get Started</a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card h-100 border-primary">
                                            <div class="card-header text-center bg-primary text-white">
                                                <h5>Professional</h5>
                                                <h4>$99<span class="text-light">/month</span></h4>
                                                <small class="badge bg-warning text-dark">Most Popular</small>
                                            </div>
                                            <div class="card-body">
                                                <ul class="feature-list">
                                                    <li>3 scanners</li>
                                                    <li>500 scans per month</li>
                                                    <li>Advanced white-labeling</li>
                                                    <li>Professional reporting</li>
                                                    <li>Priority phone support</li>
                                                    <li>Advanced client portal</li>
                                                    <li>API access</li>
                                                    <li>Custom integrations</li>
                                                    <li>Scheduled scanning</li>
                                                </ul>
                                                <div class="text-center mt-3">
                                                    {% if client.subscription_level == 'professional' %}
                                                        <button class="btn btn-outline-success" disabled>Current Plan</button>
                                                    {% else %}
                                                        <a href="/client/billing/upgrade?plan=professional" class="btn btn-primary">Start Free Trial</a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card h-100">
                                            <div class="card-header text-center">
                                                <h5>Enterprise</h5>
                                                <h4 class="text-primary">$149<span class="text-muted">/month</span></h4>
                                            </div>
                                            <div class="card-body">
                                                <ul class="feature-list">
                                                    <li>10 scanners</li>
                                                    <li>1000 scans per month</li>
                                                    <li>Complete white-labeling</li>
                                                    <li>Executive reporting</li>
                                                    <li>24/7 dedicated support</li>
                                                    <li>Multi-tenant management</li>
                                                    <li>Full API access</li>
                                                    <li>Custom development</li>
                                                    <li>SLA guarantees</li>
                                                    <li>Training & onboarding</li>
                                                </ul>
                                                <div class="text-center mt-3">
                                                    {% if client.subscription_level == 'enterprise' %}
                                                        <button class="btn btn-outline-success" disabled>Current Plan</button>
                                                    {% else %}
                                                        <a href="/contact?plan=enterprise" class="btn btn-primary">Contact Sales</a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications" role="tabpanel">
                        <div class="card settings-card">
                            <div class="card-header settings-card-header">
                                <h4 class="mb-0">Notification Preferences</h4>
                            </div>
                            <div class="card-body">
                                <form method="post">
                                    <input type="hidden" name="action" value="update_notifications">
                                    
                                    <div class="form-section">
                                        <h5>Email Notifications</h5>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" role="switch" id="emailNotifications" 
                                                   name="notification_email" value="1" 
                                                   {{ 'checked' if client.notification_email|default(true) }}>
                                            <label class="form-check-label" for="emailNotifications">
                                                Receive email notifications
                                            </label>
                                        </div>
                                        <div class="mb-3">
                                            <label for="notificationEmail" class="form-label">Notification Email</label>
                                            <input type="email" class="form-control" id="notificationEmail" 
                                                   name="notification_email_address" value="{{ client.notification_email_address|default(client.contact_email) }}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-section">
                                        <h5>Scan Alerts</h5>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" role="switch" id="scanComplete" 
                                                   name="notify_scan_complete" value="1" 
                                                   {{ 'checked' if client.notify_scan_complete|default(true) }}>
                                            <label class="form-check-label" for="scanComplete">
                                                Notify when scans complete
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" role="switch" id="criticalIssues" 
                                                   name="notify_critical_issues" value="1" 
                                                   {{ 'checked' if client.notify_critical_issues|default(true) }}>
                                            <label class="form-check-label" for="criticalIssues">
                                                Alert on critical security issues
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" role="switch" id="weeklyReports" 
                                                   name="notify_weekly_reports" value="1" 
                                                   {{ 'checked' if client.notify_weekly_reports|default(false) }}>
                                            <label class="form-check-label" for="weeklyReports">
                                                Weekly summary reports
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-section">
                                        <h5>Notification Frequency</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="notification_frequency" id="realtime" 
                                                   value="realtime" {{ 'checked' if client.notification_frequency == 'realtime' }}>
                                            <label class="form-check-label" for="realtime">
                                                Real-time notifications
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="notification_frequency" id="daily" 
                                                   value="daily" {{ 'checked' if client.notification_frequency == 'daily' }}>
                                            <label class="form-check-label" for="daily">
                                                Daily digest
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="notification_frequency" id="weekly" 
                                                   value="weekly" {{ 'checked' if client.notification_frequency == 'weekly' or not client.notification_frequency }}>
                                            <label class="form-check-label" for="weekly">
                                                Weekly digest
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save me-2"></i>Save Preferences
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card settings-card">
                                    <div class="card-header settings-card-header">
                                        <h4 class="mb-0">Change Password</h4>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" id="changePasswordForm">
                                            <input type="hidden" name="action" value="change_password">
                                            <div class="mb-3">
                                                <label for="currentPassword" class="form-label">Current Password</label>
                                                <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="newPassword" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="newPassword" name="new_password" required>
                                                <div class="form-text">Password must be at least 8 characters</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                                <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                                            </div>
                                            <div class="text-end">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-shield-check me-2"></i>Update Password
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card settings-card">
                                    <div class="card-header settings-card-header">
                                        <h4 class="mb-0">Two-Factor Authentication</h4>
                                    </div>
                                    <div class="card-body">
                                        {% if client.two_factor_enabled %}
                                            <div class="alert alert-success">
                                                <i class="bi bi-shield-check me-2"></i>
                                                Two-factor authentication is enabled
                                            </div>
                                            <p>Your account is protected with two-factor authentication. You'll need your authentication app to log in.</p>
                                            <button class="btn btn-danger" id="disableTwoFactor">
                                                <i class="bi bi-shield-slash me-2"></i>Disable 2FA
                                            </button>
                                        {% else %}
                                            <p>Add an extra layer of security to your account with two-factor authentication.</p>
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enableTwoFactorModal">
                                                <i class="bi bi-shield-plus me-2"></i>Enable 2FA
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="card settings-card mt-4">
                                    <div class="card-header settings-card-header">
                                        <h4 class="mb-0">API Keys</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>Manage API keys for your account.</p>
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Created</th>
                                                        <th>Last Used</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% if client.api_keys %}
                                                        {% for key in client.api_keys %}
                                                            <tr>
                                                                <td>{{ key.name }}</td>
                                                                <td>{{ key.created_at }}</td>
                                                                <td>{{ key.last_used|default('Never') }}</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-outline-danger" onclick="revokeApiKey('{{ key.id }}')">
                                                                        <i class="bi bi-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="4" class="text-center text-muted">No API keys created</td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                                            <i class="bi bi-plus-circle me-2"></i>Create New API Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enable Two-Factor Modal -->
    <div class="modal fade" id="enableTwoFactorModal" tabindex="-1" aria-labelledby="enableTwoFactorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enableTwoFactorModalLabel">Enable Two-Factor Authentication</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ol>
                        <li>Download and install an authenticator app (Google Authenticator, Authy, etc.)</li>
                        <li>Scan this QR code with your authenticator app:</li>
                    </ol>
                    <div class="text-center my-4">
                        <img src="/client/settings/two-factor/qr-code" alt="2FA QR Code" class="img-fluid">
                    </div>
                    <div class="alert alert-info">
                        <strong>Secret Key:</strong> <code>{{ two_factor_secret }}</code>
                        <p class="mb-0 small">Use this if you can't scan the QR code</p>
                    </div>
                    <form method="post" id="enableTwoFactorForm">
                        <input type="hidden" name="action" value="enable_two_factor">
                        <div class="mb-3">
                            <label for="verificationCode" class="form-label">Enter 6-digit code from your app</label>
                            <input type="text" class="form-control" id="verificationCode" name="verification_code" 
                                   pattern="[0-9]{6}" maxlength="6" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="enableTwoFactorForm" class="btn btn-primary">Enable 2FA</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create API Key Modal -->
    <div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyModalLabel">Create New API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="createApiKeyForm">
                    <input type="hidden" name="action" value="create_api_key">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="apiKeyName" class="form-label">API Key Name</label>
                            <input type="text" class="form-control" id="apiKeyName" name="api_key_name" 
                                   placeholder="e.g., Production API" required>
                            <div class="form-text">Choose a descriptive name for your API key</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiKeyExpiry" class="form-label">Expiration</label>
                            <select class="form-select" id="apiKeyExpiry" name="expiry">
                                <option value="never">Never</option>
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                                <option value="365">1 year</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create API Key</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Password confirmation validation
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (newPassword.length < 8) {
                alert('Password must be at least 8 characters long!');
                return;
            }
            
            this.submit();
        });
        document.addEventListener('DOMContentLoaded', function() {
            // Add submit event handlers to all settings forms
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    // Optional: Show a loading state on the button
                    const submitBtn = document.getElementById('saveProfileBtn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                    }
                            
                    // Let form submit normally - no need to prevent default
                    console.log('Profile form submitted');
                });
            }
        // Debug form submissions
        const originalSubmit = HTMLFormElement.prototype.submit;
        HTMLFormElement.prototype.submit = function() {
            console.log('Form submitted programmatically:', this);
            return originalSubmit.apply(this, arguments);
        };

        // Explicitly add event handlers to all form buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('button[type="submit"]').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    console.log('Submit button clicked:', this);
                    // Find the closest form and explicitly call submit()
                    const form = this.closest('form');
                    if (form) {
                        console.log('Found parent form:', form);
                    }
                });
            });
        });
            // Debug helper to check if forms exist
            console.log('Profile form found:', !!profileForm);
    
            // Add form submission debugging for all forms
            document.querySelectorAll('form').forEach(function(form, index) {
                console.log(`Form ${index} action:`, form.action, 'method:', form.method);
                form.addEventListener('submit', function(e) {
                    console.log(`Form ${index} submitted`);
                });
            });
        });
        // Disable two-factor authentication
        document.getElementById('disableTwoFactor')?.addEventListener('click', function() {
            if (confirm('Are you sure you want to disable two-factor authentication? This will make your account less secure.')) {
                // Submit form to disable 2FA
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = '<input type="hidden" name="action" value="disable_two_factor">';
                document.body.appendChild(form);
                form.submit();
            }
        });
        
        // Revoke API key
        function revokeApiKey(keyId) {
            if (confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) {
                // Submit form to revoke API key
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="action" value="revoke_api_key">
                    <input type="hidden" name="api_key_id" value="${keyId}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Create API key form handler
        document.getElementById('createApiKeyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            
            // Submit form
            this.submit();
        });
    </script>
</body>
</html>
