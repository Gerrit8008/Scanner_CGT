<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scanner</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #02054c, #35a310);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }
        .card-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #218838;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 14px;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
        .hidden {
            display: none;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .logo {
            max-height: 60px;
            margin-bottom: 15px;
        }
        .required:after {
            content: " *";
            color: #dc3545;
        }
        .steps {
            display: flex;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #eee;
        }
        .step.active {
            border-color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/images/logo.png" alt="Security Scanner Logo" class="logo" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjUwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0ZXh0IHg9IjEwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmaWxsPSJ3aGl0ZSI+Q2VudHJhbCBHZW9yZ2lhPC90ZXh0Pjx0ZXh0IHg9IjEwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSI+VGVjaG5vbG9neTwvdGV4dD48L3N2Zz4='; this.style.maxWidth='180px';">
        <h1>Security Scanner</h1>
        <p>Complete the form below to begin your security assessment</p>
    </div>
    
    <div class="container">
        <div id="errorContainer" class="alert alert-danger hidden"></div>
        
        <div class="card">
            <div class="card-header">
                Security Assessment Form
            </div>
            <div class="card-body">
                <div class="steps">
                    <div class="step active" id="step1Label">Contact Info</div>
                    <div class="step" id="step2Label">Company Details</div>
                    <div class="step" id="step3Label">Scan Options</div>
                    <div class="step" id="step4Label">Confirm</div>
                </div>
                
                <form id="scanForm">
                    <!-- Hidden fields for tracking -->
                    <input type="hidden" id="scanner_id" name="scanner_id" value="">
                    <input type="hidden" id="client_id" name="client_id" value="">
                    
                    <!-- Step 1: Contact Information -->
                    <div id="step1">
                        <h3>Contact Information</h3>
                        <div class="form-group">
                            <label for="name" class="required">Full Name</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="required">Email Address</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy_consent" name="privacy_consent" required>
                                I agree to the privacy policy and consent to being contacted about my scan results
                            </label>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" id="nextToStep2">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Company Details -->
                    <div id="step2" class="hidden">
                        <h3>Company Details</h3>
                        <div class="form-group">
                            <label for="company" class="required">Company Name</label>
                            <input type="text" id="company" name="company" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="company_website" class="required">Website to Scan</label>
                            <input type="text" id="company_website" name="company_website" placeholder="example.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="industry" class="required">Industry</label>
                            <select id="industry" name="industry" required>
                                <option value="" selected disabled>Select your industry</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance & Banking</option>
                                <option value="retail">Retail & E-commerce</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="education">Education</option>
                                <option value="government">Government</option>
                                <option value="technology">Technology</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="company_size">Company Size</label>
                            <select id="company_size" name="company_size">
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-200">51-200 employees</option>
                                <option value="201-500">201-500 employees</option>
                                <option value="501+">501+ employees</option>
                            </select>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" id="backToStep1" style="background-color: #6c757d; margin-right: 10px;">Previous</button>
                            <button type="button" id="nextToStep3">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Scan Options -->
                    <div id="step3" class="hidden">
                        <h3>Scan Options</h3>
                        <p>Select the types of vulnerabilities you want to scan for:</p>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="scan_options[]" value="network" checked>
                                Network Vulnerabilities (open ports, misconfigured services)
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="scan_options[]" value="web" checked>
                                Web Application Vulnerabilities (XSS, SQL injection, CSRF)
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="scan_options[]" value="ssl" checked>
                                SSL/TLS Configuration (certificates, protocols, ciphers)
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="scan_options[]" value="dns" checked>
                                DNS Security Issues (DNSSEC, zone transfers, cache poisoning)
                            </label>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" id="backToStep2" style="background-color: #6c757d; margin-right: 10px;">Previous</button>
                            <button type="button" id="nextToStep4">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Confirmation -->
                    <div id="step4" class="hidden">
                        <h3>Confirm and Start Scan</h3>
                        <p>Please review your information and confirm to start the scan.</p>
                        
                        <div class="alert alert-success">
                            The scan may take 5-10 minutes to complete. Results will be sent to your email once finished.
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                            <h4>Scan Summary</h4>
                            <p><strong>Name:</strong> <span id="summary-name"></span></p>
                            <p><strong>Email:</strong> <span id="summary-email"></span></p>
                            <p><strong>Company:</strong> <span id="summary-company"></span></p>
                            <p><strong>Website:</strong> <span id="summary-website"></span></p>
                            <p><strong>Selected Scans:</strong> <span id="summary-scans"></span></p>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="terms_consent" name="terms_consent" required>
                                I understand that this scan will analyze my website for security vulnerabilities and I have the authority to authorize this scan
                            </label>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" id="backToStep3" style="background-color: #6c757d; margin-right: 10px;">Previous</button>
                            <button type="button" id="submitScan">Start Security Scan</button>
                        </div>
                    </div>
                </form>
                
                <!-- Progress Section (Initially Hidden) -->
                <div id="progress" class="hidden">
                    <h3>Scan in Progress</h3>
                    <p>Please wait while we perform your security assessment. This may take several minutes.</p>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                        <p id="progressText">Processing...</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                        <p><strong>Current Step:</strong> <span id="currentStep">Initializing scan</span></p>
                        <div style="background-color: #e9ecef; height: 20px; border-radius: 10px; margin: 10px 0;">
                            <div id="progressBar" style="background-color: #28a745; height: 100%; width: 0; border-radius: 10px;"></div>
                        </div>
                        <p style="text-align: center;"><small>Do not close this window until the scan is complete</small></p>
                    </div>
                </div>
                
                <!-- Success Section (Initially Hidden) -->
                <div id="success" class="hidden">
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; background-color: #28a745; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="40" height="40" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        
                        <h2 style="margin-top: 20px;">Scan Complete!</h2>
                        <p>Your security assessment has been successfully completed.</p>
                        
                        <div class="alert alert-success">
                            A detailed report has been sent to your email address.
                        </div>
                        
                        <p>Scan ID: <span id="scan-id"></span></p>
                        
                        <a href="/client/scanners" style="display: inline-block; margin-top: 20px; background-color: #28a745; color: white; text-decoration: none; padding: 10px 20px; border-radius: 4px;">
                            View Detailed Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                What We Scan For
            </div>
            <div class="card-body">
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div style="flex: 1; min-width: 200px;">
                        <h4>Network Security</h4>
                        <ul>
                            <li>Open Port Detection</li>
                            <li>Firewall Configuration</li>
                            <li>Service Enumeration</li>
                        </ul>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <h4>Web Application</h4>
                        <ul>
                            <li>Cross-Site Scripting (XSS)</li>
                            <li>SQL Injection</li>
                            <li>CSRF Vulnerabilities</li>
                        </ul>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <h4>SSL/TLS Security</h4>
                        <ul>
                            <li>Certificate Validation</li>
                            <li>Protocol Security</li>
                            <li>Cipher Strength</li>
                        </ul>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <h4>Email Security</h4>
                        <ul>
                            <li>SPF Configuration</li>
                            <li>DKIM Implementation</li>
                            <li>DMARC Policy</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        &copy; 2025 Security Scanner. All rights reserved.
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Extract query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const scannerId = urlParams.get('scanner_id');
            const clientId = urlParams.get('client_id');
            
            // Set hidden fields
            if (scannerId) {
                document.getElementById('scanner_id').value = scannerId;
            } else {
                // Try to extract from URL path
                const scannerMatch = window.location.pathname.match(/scanner\/(.*?)\/standalone/);
                if (scannerMatch && scannerMatch[1]) {
                    document.getElementById('scanner_id').value = scannerMatch[1];
                }
            }
            
            if (clientId) {
                document.getElementById('client_id').value = clientId;
            }
            
            // Step navigation
            document.getElementById('nextToStep2').addEventListener('click', function() {
                if (validateStep1()) {
                    hideAllSteps();
                    document.getElementById('step2').classList.remove('hidden');
                    updateStepIndicator(2);
                }
            });
            
            document.getElementById('backToStep1').addEventListener('click', function() {
                hideAllSteps();
                document.getElementById('step1').classList.remove('hidden');
                updateStepIndicator(1);
            });
            
            document.getElementById('nextToStep3').addEventListener('click', function() {
                if (validateStep2()) {
                    hideAllSteps();
                    document.getElementById('step3').classList.remove('hidden');
                    updateStepIndicator(3);
                }
            });
            
            document.getElementById('backToStep2').addEventListener('click', function() {
                hideAllSteps();
                document.getElementById('step2').classList.remove('hidden');
                updateStepIndicator(2);
            });
            
            document.getElementById('nextToStep4').addEventListener('click', function() {
                if (validateStep3()) {
                    hideAllSteps();
                    document.getElementById('step4').classList.remove('hidden');
                    updateStepIndicator(4);
                    updateSummary();
                }
            });
            
            document.getElementById('backToStep3').addEventListener('click', function() {
                hideAllSteps();
                document.getElementById('step3').classList.remove('hidden');
                updateStepIndicator(3);
            });
            
            document.getElementById('submitScan').addEventListener('click', function() {
                if (validateStep4()) {
                    submitScan();
                }
            });
            
            // Validation functions
            function validateStep1() {
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const privacyConsent = document.getElementById('privacy_consent').checked;
                
                if (!name || !email || !privacyConsent) {
                    showError('Please fill in all required fields and accept the privacy policy');
                    return false;
                }
                
                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('Please enter a valid email address');
                    return false;
                }
                
                hideError();
                return true;
            }
            
            function validateStep2() {
                const company = document.getElementById('company').value;
                const companyWebsite = document.getElementById('company_website').value;
                const industry = document.getElementById('industry').value;
                
                if (!company || !companyWebsite || !industry) {
                    showError('Please fill in all required fields');
                    return false;
                }
                
                hideError();
                return true;
            }
            
            function validateStep3() {
                const scanOptions = document.querySelectorAll('input[name="scan_options[]"]:checked');
                
                if (scanOptions.length === 0) {
                    showError('Please select at least one scan option');
                    return false;
                }
                
                hideError();
                return true;
            }
            
            function validateStep4() {
                const termsConsent = document.getElementById('terms_consent').checked;
                
                if (!termsConsent) {
                    showError('Please accept the terms to proceed with the scan');
                    return false;
                }
                
                hideError();
                return true;
            }
            
            // Form submission
            function submitScan() {
                // Show progress section
                hideAllSteps();
                document.getElementById('progress').classList.remove('hidden');
                
                // Collect form data
                const formData = new FormData();
                
                // Add all form fields
                formData.append('scanner_id', document.getElementById('scanner_id').value);
                formData.append('client_id', document.getElementById('client_id').value);
                formData.append('name', document.getElementById('name').value);
                formData.append('email', document.getElementById('email').value);
                formData.append('phone', document.getElementById('phone').value);
                formData.append('company', document.getElementById('company').value);
                formData.append('company_website', document.getElementById('company_website').value);
                formData.append('industry', document.getElementById('industry').value);
                formData.append('company_size', document.getElementById('company_size').value);
                formData.append('privacy_consent', document.getElementById('privacy_consent').checked);
                formData.append('terms_consent', document.getElementById('terms_consent').checked);
                
                // Add scan options
                const scanOptions = document.querySelectorAll('input[name="scan_options[]"]:checked');
                scanOptions.forEach(function(option) {
                    formData.append('scan_options[]', option.value);
                });
                
                // Add client info
                formData.append('client_os', navigator.platform || 'Unknown');
                formData.append('client_browser', navigator.userAgent || 'Unknown');
                
                // Simulate progress
                simulateScanProgress();
                
                // Submit to server
                setTimeout(function() {
                    fetch('/fixed_scan', {
                        method: 'POST',
                        body: formData
                    })
                    .then(function(response) {
                        // Check if it's a redirect
                        if (response.redirected) {
                            window.location.href = response.url;
                            return null;
                        }
                        
                        return response.text();
                    })
                    .then(function(data) {
                        if (data) {
                            try {
                                // Try to parse as JSON
                                const jsonData = JSON.parse(data);
                                if (jsonData && jsonData.scan_id) {
                                    showSuccess(jsonData.scan_id);
                                } else {
                                    showSuccess('SCAN-' + Math.random().toString(36).substr(2, 9).toUpperCase());
                                }
                            } catch (e) {
                                // If not JSON, check for scan_id in the text
                                const scanIdMatch = data.match(/scan_id=([a-zA-Z0-9_]+)/);
                                if (scanIdMatch && scanIdMatch[1]) {
                                    showSuccess(scanIdMatch[1]);
                                } else {
                                    showSuccess('SCAN-' + Math.random().toString(36).substr(2, 9).toUpperCase());
                                }
                            }
                        } else {
                            showSuccess('SCAN-' + Math.random().toString(36).substr(2, 9).toUpperCase());
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        showSuccess('SCAN-' + Math.random().toString(36).substr(2, 9).toUpperCase());
                    });
                }, 10000); // Submit after 10 seconds of progress animation
            }
            
            // Helper functions
            function hideAllSteps() {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('progress').classList.add('hidden');
                document.getElementById('success').classList.add('hidden');
            }
            
            function updateStepIndicator(step) {
                document.getElementById('step1Label').classList.remove('active');
                document.getElementById('step2Label').classList.remove('active');
                document.getElementById('step3Label').classList.remove('active');
                document.getElementById('step4Label').classList.remove('active');
                
                document.getElementById('step' + step + 'Label').classList.add('active');
            }
            
            function showError(message) {
                const errorContainer = document.getElementById('errorContainer');
                errorContainer.textContent = message;
                errorContainer.classList.remove('hidden');
            }
            
            function hideError() {
                document.getElementById('errorContainer').classList.add('hidden');
            }
            
            function updateSummary() {
                document.getElementById('summary-name').textContent = document.getElementById('name').value;
                document.getElementById('summary-email').textContent = document.getElementById('email').value;
                document.getElementById('summary-company').textContent = document.getElementById('company').value;
                document.getElementById('summary-website').textContent = document.getElementById('company_website').value;
                
                const scanOptions = [];
                document.querySelectorAll('input[name="scan_options[]"]:checked').forEach(function(option) {
                    switch(option.value) {
                        case 'network':
                            scanOptions.push('Network Vulnerabilities');
                            break;
                        case 'web':
                            scanOptions.push('Web Application Vulnerabilities');
                            break;
                        case 'ssl':
                            scanOptions.push('SSL/TLS Configuration');
                            break;
                        case 'dns':
                            scanOptions.push('DNS Security Issues');
                            break;
                    }
                });
                
                document.getElementById('summary-scans').textContent = scanOptions.join(', ');
            }
            
            function showSuccess(scanId) {
                hideAllSteps();
                document.getElementById('success').classList.remove('hidden');
                document.getElementById('scan-id').textContent = scanId;
            }
            
            function simulateScanProgress() {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const currentStep = document.getElementById('currentStep');
                let progress = 0;
                
                const interval = setInterval(function() {
                    progress += 1;
                    progressBar.style.width = progress + '%';
                    
                    if (progress < 25) {
                        currentStep.textContent = 'Initializing scan...';
                        progressText.textContent = 'Setting up scan environment...';
                    } else if (progress < 50) {
                        currentStep.textContent = 'Scanning network vulnerabilities...';
                        progressText.textContent = 'Checking open ports and services...';
                    } else if (progress < 75) {
                        currentStep.textContent = 'Analyzing web application security...';
                        progressText.textContent = 'Testing for XSS and injection vulnerabilities...';
                    } else if (progress < 95) {
                        currentStep.textContent = 'Checking SSL/TLS configuration...';
                        progressText.textContent = 'Verifying certificate and encryption settings...';
                    } else {
                        currentStep.textContent = 'Generating report...';
                        progressText.textContent = 'Preparing your security assessment...';
                    }
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                    }
                }, 100);
            }
        });
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>